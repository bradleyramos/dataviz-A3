<!DOCTYPE html>

<head>
  <link rel="shortcut icon" href="#">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="./styles.css" type="text/css" media="screen" charset="utf-8">
  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script src="https://d3js.org/d3-voronoi.v1.min.js"></script>
</head>

<body>
  <div class="flex-container">
    <div class="chatbot">
      <img src="images/bot_icon.png" alt="ChatBot" />
      <div class="message" id="chat_message"> Welcome to our viz! Pick your favorite sector to get started.</div>
    </div>
    <div class="flex-grid">
      <div class="col-1">
        <div class="sectors">
          <div class="tabs">
            <button class="tablink" id="tablink-tech" onclick="selectSector(event, 'Technology')">Technology</button>
            <button class="tablink" id="tablink-fin" onclick="selectSector(event, 'Finance')">Finance</button>
            <button class="tablink" id="tablink-tran"
              onclick="selectSector(event, 'Transportation')">Transportation</button>
          </div>
          <div id="sector-selected" class="sector-content">
            <div id="categories">
              <div class="category-select">
                <button class="catlink" id="catbutton-win" onclick="selectCat(event, 'Winning')">Winning</button>
                <button class="catlink" id="catbutton-act" onclick="selectCat(event, 'Active')">Constant</button>
                <button class="catlink" id="catbutton-lose" onclick="selectCat(event, 'Losing')">Losing</button>
              </div>
              <div id="stocks-container">
                <div class="stocks-list">
                  <div class="sect-title">Filtered Stocks:</div>
                  <div id="Winning" class="cat-content">
                    <ul class="stocks" id="WinningList">
                    </ul>
                  </div>
                  <div id="Active" class="cat-content">
                    <ul class="stocks" id="ActiveList">
                    </ul>
                  </div>
                  <div id="Losing" class="cat-content">
                    <ul class="stocks" id="LosingList">
                    </ul>
                  </div>
                </div>
                <div class="selected-container">
                  <div class="selected-title">Selected:</div>
                  <div id="selected" class="selected-symbols"></div>
                  <input type="button" id="clear_button" value="Clear Selected" onclick="clearSymbols()">
                  <input type="button" id="enter_button" value="View Chart">
                  <div id="submit-stocks"></div>
                </div>
              </div>
            </div>
          </div>
          <div id="chart"></div>
        </div>
      </div>
      <div class="col-2">
        <div id="portfolio_and_results"
          style="display: flex;justify-content: space-evenly;margin-top: 3%;flex-direction: row;">
          <div id="portfolio" class="portfolio-container">
            <div class="portfolio-title">My Portfolio:</div>
            <div id="selected-portfolio" class="selected-portfolio"></div>
            <input type="button" id="portfolio-button" value="View Results"
              onclick="analyzeStocks(); createStakeGraph();">
          </div>
          <div id="results" class="portfolio-container">
            <div class="portfolio-title">Results after 1 Year:</div>
            <div id="results-content" class="selected-portfolio"></div>
          </div>
        </div>
        <div id="chart-2"></div>
      </div>
    </div>
  </div>

  <script src="./bundle.js"></script>
  <script>
    // Fetch some huge static data
    function getStaticData(resolve, reject) {
      fetch("/static_datasets/NYSE.json")
        .then(response => response.json())
        .then(json => resolve(json));
    }

    var currSector = '';
    var currCategory = '';
    async function filterBySector(sectorName) {
      let prom = new Promise((resolve, reject) => getStaticData(resolve, reject));
      let staticData = await prom;
      let matched_stocks = staticData.filter(function (entry) {
        return entry.Sector === sectorName;
      });
      if (!matched_stocks.length) alert('Could not fetch that sector.');
      return matched_stocks;
    }

    async function filterByCategory(cat, sector) {
      let sectorData = await sector;
      let matched;
      switch (cat) {
        case 'Winning':
          matched = sectorData.filter(function (entry) {
            return parseFloat(entry["% Change"]) >= 3;
          });
          break;
        case 'Losing':
          matched = sectorData.filter(function (entry) {
            return parseFloat(entry["% Change"]) <= -3;
          });
          break;
        default:
          matched = sectorData.filter(function (entry) {
            return (parseFloat(entry["% Change"]) == 0);
          });
      }
      if (!matched.length) alert('Could not fetch that sector.');
      // else {
      //   console.log(matched)
      // }
      return matched;
    }

    let count = 0;
    let selected_stocks = [];
    function pushSymbol(evt, sym) {
      if (selected_stocks.includes(sym)) {
        alert('You already added this stock!')
      } else {
        if (count == 4) {
          alert('You can only add 4 stocks at a time!');
        } else {
          evt.currentTarget.className += " active";
          document.getElementById("selected").innerHTML += "<div class=\"symbol\">" + String(sym) + "</div>";
          document.getElementById("selected-portfolio").innerHTML += "\
            <div stlye = \"display: flex; flex-direction: row;\">\
              <label class=\"portfolio-symbol\" for=\"" + String(sym) + "\">Stake in " + String(sym) + ": $</label>\
              <input type=\"number\" id=\""+ String(sym) + "\" name=\"" + String(sym) + "\"min=\"0\" max=\"10000\">\
            </div>";
          selected_stocks.push(sym);
          count++;
          if (count == 1) {
            document.getElementById("submit-stocks").innerHTML = sym;
          } else {
            document.getElementById("submit-stocks").innerHTML += "," + sym;
          }
        }
      }
    }

    function clearSymbols() {
      count = 0;
      selected_stocks = [];
      tablinks = document.getElementsByClassName("add-button");
      for (let i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById("selected").innerHTML = "";
      document.getElementById("submit-stocks").innerHTML = "";
      document.getElementById("chart").innerHTML = "";
      document.getElementById("selected-portfolio").innerHTML = "";
      document.getElementById("results-content").innerHTML = "";
      document.getElementById("chart-2").innerHTML = "";

      document.getElementById("portfolio").style.display = "none";
      document.getElementById("results").style.display = "none";

      window.sessionStorage.clear();
    }

    // Perform analysis of portfolio  
    let initial_stakes = [];
    function analyzeStocks() {
      initial_stakes = [];
      let final_stakes = [];
      document.getElementById("results").style.display = "flex";
      for (let i = 0; i < selected_stocks.length; i++) {
        let s = selected_stocks[i];
        let temp_data_raw = window.sessionStorage.getItem(`${s}_close`);
        if (!temp_data_raw) {
          alert('You must hit \"View Chart\" before \"View Results\" with a new stock!');
          return;
        }
        let temp_data = temp_data_raw.split(',').map(Number);
        let initial_closing = temp_data[0];
        let final_closing = temp_data[temp_data.length - 1];
        let stake = Number(document.getElementById(s).value).toFixed(2);

        initial_stakes.push(stake);
        final_stakes.push((final_closing / initial_closing) * stake);
      }
      console.log('stakes in each stock:', final_stakes);

      // Remove past table
      let results_content = document.getElementById("results-content");
      if (results_content.firstChild) {
        results_content.removeChild(results_content.firstChild);
      }

      // Insert new table
      let table = document.createElement("table");
      table.style.width = "100%";


      // Insert header
      let header = table.insertRow();
      header.insertCell().appendChild(document.createTextNode("Stock"));
      header.insertCell().appendChild(document.createTextNode("Initial Stake"));
      header.insertCell().appendChild(document.createTextNode("Final Stake"));

      // Insert other rows
      for (let i = 0; i < initial_stakes.length; i++) {
        let tr = table.insertRow();

        let cell1 = tr.insertCell();
        cell1.appendChild(document.createTextNode(selected_stocks[i]));
        cell1.style.border = "1px solid #dddddd";

        let cell2 = tr.insertCell();
        cell2.appendChild(document.createTextNode(`$${initial_stakes[i]}`));
        cell2.style.border = "1px solid #dddddd";

        let cell3 = tr.insertCell();
        cell3.appendChild(document.createTextNode(`$${final_stakes[i].toFixed(2)}`));
        cell3.style.border = "1px solid #dddddd";
      }

      // Apend table to parent
      results_content.appendChild(table);

      // Update chatbot message
      document.getElementById("chat_message").innerHTML = "Here are your results!\
        The graph on the bottom right shows how your portfolio's value changes over 1 year.";
    }

    // Update filter tabs, based on code from https://www.w3schools.com/howto/howto_js_tabs.asp
    async function selectSector(evt, sectorName) {
      var i, tabcontent, tablinks;
      // Get all elements with class="sector-content" and hide them
      tabcontent = document.getElementById("sector-selected").style.display = "flex";
      // Get all elements with class="tablinks" and remove the class "active"
      tablinks = document.getElementsByClassName("tablink");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      // Show the current tab, and add an "active" class to the button that opened the tab
      // document.getElementById("sector-selected").style.display = "block";
      evt.currentTarget.className += " active";
      // Show the next step
      document.getElementById("categories").style.display = "flex";
      // Update chat bot to indicate the next step.
      document.getElementById("chat_message").innerHTML = "Great! Now decide if you want to know more about stocks that are going up (Winning), undetermined (Constant), or going down (Losing)."
      // document.getElementById("catbutton-win").click();
      currSector = sectorName;
      if (currCategory) {
        // populate stocks
        let filteredData = await filterByCategory(currCategory, filterBySector(currSector));
        let stock;
        document.getElementById(currCategory + "List").innerHTML = "";
        for (let x in filteredData) {
          stock = filteredData[x];
          document.getElementById(currCategory + "List").innerHTML += "<li class=\"stock\">" + stock.Symbol + "<input class=\"add-button\" type=\"button\" value=\"+\" onclick=\"pushSymbol(event, \'" + stock.Symbol + "\')\"></li>";
        }
      }
    }

    async function selectCat(evt, catName) { // same as above but for category
      var i, tabcontent, tablinks;
      tabcontent = document.getElementsByClassName("cat-content");
      for (i = 0; i < tabcontent.length; i++) {
        tabcontent[i].style.display = "none";
      }
      tablinks = document.getElementsByClassName("catlink");
      for (i = 0; i < tablinks.length; i++) {
        tablinks[i].className = tablinks[i].className.replace(" active", "");
      }
      document.getElementById(catName).style.display = "block";
      document.getElementById('stocks-container').style.display = "flex";
      evt.currentTarget.className += " active";
      document.getElementById("chat_message").innerHTML = "You're almost there! Here are the symbols and prices of stocks based on your filters. Select up to 4 stocks that seem interesting to take a look at their historic trends, or refine your search."
      currCategory = catName;
      // populate stocks
      let filteredData = await filterByCategory(currCategory, filterBySector(currSector));
      let stock;
      document.getElementById(currCategory + "List").innerHTML = "";
      for (let x in filteredData) {
        stock = filteredData[x];
        document.getElementById(currCategory + "List").innerHTML += "<li class=\"stock\">" + stock.Symbol + "<div>" + stock["Last Sale"] + "</div>" + "<input class=\"add-button\" type=\"button\" value=\"+\" onclick=\"pushSymbol(event, \'" + stock.Symbol + "\')\"></li>";
      }
    }

    function createStakeGraph() {
      /* Delete previous graph*/
      let chart2 = document.getElementById("chart-2");
      if (chart2.firstChild) {
        chart2.innerHTML = "";
      }

      /* Setup container */
      const container_width = 850;
      const container_height = 425

      let svg = d3.select(chart2)
        .append("svg")
        .attr("id", "svg2_id")
        .attr("width", container_width)
        .attr("height", container_height);

      let margin = { top: 25, left: 50, bottom: 50, right: 100 };

      let height = container_height - margin.top - margin.bottom;
      let width = container_width - margin.right - margin.left;

      let g = svg.append('g')
        .attr("transform", `translate(${margin.left}, ${margin.top})`)
        .attr("overflow", "hidden")
        .attr("pointer-events", "all");

      /* Extract important info from data */
      let all_data = [];
      let dates = window.sessionStorage.getItem("dates").split(',').map(x => new Date(x));
      for (let i = 0; i < selected_stocks.length; i++) {
        all_data.push(window.sessionStorage.getItem(`${selected_stocks[i]}_close`).split(',').map(Number));
      }

      let relevant_data = [];
      for (let i = 0; i < all_data[0].length; i++) {
        let weighted_sum = 0;
        for (let j = 0; j < selected_stocks.length; j++) {
          weighted_sum += initial_stakes[j] * (all_data[j][i] / all_data[j][0]);
        }
        relevant_data.push([dates[i], weighted_sum]);
      }


      let minX = d3.min(relevant_data, d => d[0]);
      let maxX = d3.max(relevant_data, d => d[0]);
      let minY = d3.min(relevant_data, d => d[1]);
      let maxY = d3.max(relevant_data, d => d[1]);

      /* Create scales/axes */
      let xScale = d3.scaleTime()
        .range([0, width])
        .domain([minX, maxX]);

      let yScale = d3.scaleLinear()
        .range([height, 2])
        .domain([minY, maxY]);

      let line = d3.line()
        .x(d => xScale(d[0]))
        .y(d => yScale(d[1]));

      let xAxis = d3.axisBottom(xScale);
      let yAxis = d3.axisLeft(yScale);

      /* Create brush */
      let brush = d3.brushX()
          .extent([[0, 0], [width, height]])
          .on("end", brushEnded);
      let idleTimeout;
      let idleDelay = 350;

      svg.append('g')
          .attr("class", "brush")
          .attr("transform", `translate(${margin.left}, ${margin.top})`)
          .call(brush);

      /* Plot axes */
      g.append('g')
          .attr("class", "axis--x")
          .attr("transform", `translate(0, ${height})`)
          .call(xAxis);

      g.append('g')
          .attr("class", "axis--y")
          .call(yAxis)
          .append("text")
          .attr("transform", "rotate(-90)")
          .attr('y', 0 - margin.left)
          .attr('x', 0 - (height / 2))
          .attr("dy", "1em")
          .attr("text-anchor", "middle")
          .attr("fill", "rgb(54, 54, 54)")
          .attr("font-size", "1.2em")
          .text("Total Stake Worth (USD)");

      g.append("defs")
          .append("clipPath")
          .attr("id", "clip")
          .append("rect")
          .attr('x', 0)
          .attr('y', 0)
          .attr("width", width)
          .attr("height", height);

      /* Plot line and circles */
      let main = g.append('g')
          .attr("class", "main")
          .attr("clip-path", "url(#clip)");

      main.append("path")
          .datum(relevant_data)
          .attr('d', line)
          .attr("stroke", "purple")
          .attr("stroke-width", 2)
          .attr("fill", "none")
          .attr("class", "line")
          .attr("pointer-events", "none");

      main.selectAll(".circle")
          .data(relevant_data)
          .enter()
          .append("circle")
              .attr("cx", d => xScale(d[0]))
              .attr("cy", d => yScale(d[1]))
              .attr('r', 2)
              .attr("fill", "white")
              .attr("stroke", "purple")
              .attr("stroke-width", 1)
              .attr("class", "circles");
      
      /* Voronoi diagram */
      let voronoi_diagram = d3.voronoi()
          .x(d => xScale(d[0]))
          .y(d => yScale(d[1]))
          .size([container_width, container_height])(relevant_data);

      let voronoi_radius = width;

      /* Focus, Tooltip, & Overlay */
      let focus = g.append('g')
          .style("display", "none");

      focus.append("line")
          .attr("id", "focusLineX")
          .attr("class", "focusLine");
      focus.append("line")
          .attr("id", "focusLineY")
          .attr("class", "focusLine");
      focus.append("circle")
          .attr("id", "focusCircle")
          .attr('r', 2)
          .attr("class", "circle focusCirle");

      let tooltip = g.append('g')  
          .style("display", "none");

      tooltip.append("rect")
          .attr("id", "tooltip_rect")
          .attr("class", "tooltip_rect")
          .attr("rx", 5);
      tooltip.append("text")
          .attr("id", "tooltip_text_date")
          .attr("fill", "rgb(0, 0, 0)")
          .attr("font-size", "0.75em")
          .attr("text-anchor", "middle");
      tooltip.append("text")
          .attr("id", "tooltip_text_price")
          .attr("fill", "rgb(0, 0, 0)")
          .attr("font-size", "0.75em")
          .attr("text-anchor", "middle");

      svg.select(".overlay")
          .attr("width", width)
          .attr("height", height)
          .on("mouseover", () => { 
              focus.style("display", null);
              tooltip.style("display", null);
          })
          .on("mouseout", () => { 
              focus.style("display", "none");
              tooltip.style("display", "none");
          })
          .on("mousemove", function (event) {
              let [mx, my] = d3.pointer(event, this);

              let site = voronoi_diagram.find(mx, my, voronoi_radius);

              let x = site[0];
              let y = site[1];

              focus.select("#focusCircle")
                  .attr("cx", x)
                  .attr("cy", y);
              focus.select("#focusLineX")
                  .attr("x1", x).attr("y1", yScale(yScale.domain()[0]))
                  .attr("x2", x).attr("y2", yScale(yScale.domain()[1]));
              focus.select("#focusLineY")
                  .attr("x1", xScale(xScale.domain()[0])).attr("y1", y)
                  .attr("x2", xScale(xScale.domain()[1])).attr("y2", y);
                  
              tooltip.attr(`transform`, `translate(${(x - 75)}, ${(y + 10)})`);
              tooltip.select("#tooltip_text_date")
                  .text(`${d3.timeFormat("%x")(xScale.invert(x))}`)
                  .attr('x', 32.5)
                  .attr('y', 10.5);
              tooltip.select("#tooltip_text_price")
                  .text(`$${yScale.invert(y).toFixed(2)}`)
                  .attr('x', 32.5)
                  .attr('y', 25);
              tooltip.select("#tooltip_rect")
                  .attr('x', 0)
                  .attr('y', 0);
          })
          .on("dblclick", () => {
              xScale.domain([minX, maxX]);
              zoom();
          });

      /* Brushing for zooming */
      function brushEnded(event) {
          let selection = event.selection;
          if (selection === null) {
              if (!idleTimeout) return idleTimeout = setTimeout(idled, idleDelay);
              xScale.domain([minX, maxX]);
          }
          else {
              xScale.domain([xScale.invert(selection[0]), xScale.invert(selection[1])]);
              svg.select(".brush").call(brush.move, null);
          }
          zoom();
      }

      function idled() {
          idleTimeout = null;
      }

      function zoom() {
          let t = svg.transition().duration(750);

          svg.select(".axis--x").transition(t).call(xAxis);
          g.select(".axis--y").transition(t).call(yAxis);
          g.selectAll(".circles").transition(t)
              .attr("cx", d => xScale(d[0]))
              .attr("cy", d => yScale(d[1]));
          g.selectAll(".line").transition(t)
              .attr("d", d => line(d));

          voronoi_diagram = d3.voronoi()
              .x(d => xScale(d[0]))
              .y(d => yScale(d[1]))
              .size([container_width, container_height])(relevant_data);
      }
    }
  </script>
</body>